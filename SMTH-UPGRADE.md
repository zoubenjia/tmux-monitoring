# SMTH BBS è„šæœ¬é˜²æ‰çº¿å‡çº§æ–¹æ¡ˆ

## æ–¹æ¡ˆæ¦‚è¿°

åŸºäºä½ ç°æœ‰çš„ `/Users/zoubenjia/scripts/smth.tcl`ï¼Œæä¾›ä¸¤ç§é˜²æ‰çº¿æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å¢å¼ºç‰ˆè„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# ç›´æ¥ä½¿ç”¨å¢å¼ºç‰ˆ
./smth-robust.tcl [å‚æ•°]

# æˆ–ä½¿ç”¨å¯åŠ¨å™¨é€‰æ‹©
./smth-launcher.sh
```

### æ–¹æ¡ˆäºŒï¼šå‡çº§ç°æœ‰è„šæœ¬

å¦‚æœä½ æƒ³ç›´æ¥ä¿®æ”¹ `/Users/zoubenjia/scripts/smth.tcl`ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤ï¼š

#### 1. å¤‡ä»½åŸè„šæœ¬
```bash
cp /Users/zoubenjia/scripts/smth.tcl /Users/zoubenjia/scripts/smth.tcl.backup
```

#### 2. å…³é”®æ”¹åŠ¨ç‚¹

**æ·»åŠ é˜²æ‰çº¿é…ç½®**ï¼ˆåœ¨å˜é‡å£°æ˜åï¼‰ï¼š
```tcl
# é˜²æ‰çº¿é…ç½®
set reconnect_attempts 0
set max_reconnect_attempts 5
set heartbeat_interval 120
```

**æ·»åŠ æ—¥å¿—å‡½æ•°**ï¼š
```tcl
proc log_msg {msg} {
    puts "\\033\\[33m\\[$(date '+%H:%M:%S')\\] $msg\\033\\[0m"
}
```

**æ·»åŠ å¿ƒè·³å‡½æ•°**ï¼š
```tcl
proc send_heartbeat {} {
    global heartbeat_interval
    send " \\b"
    log_msg "ğŸ’— å‘é€å¿ƒè·³ä¿æŒè¿æ¥"
    after [expr $heartbeat_interval * 1000] send_heartbeat
}
```

**ä¿®æ”¹ interact éƒ¨åˆ†**ï¼ˆæ›¿æ¢åŸæ¥çš„ `interact`ï¼‰ï¼š
```tcl
# å¯åŠ¨å¿ƒè·³
after [expr 120 * 1000] send_heartbeat

interact {
    -o -re "connection.*closed|è¿æ¥.*å…³é—­|Connection.*lost" {
        log_msg "âš ï¸ æ£€æµ‹åˆ°è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿"
        # é‡è¿é€»è¾‘
    }
    -o eof {
        log_msg "âš ï¸ è¿æ¥æ„å¤–å…³é—­"
        # é‡è¿é€»è¾‘
    }
}
```

## åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | åŸç‰ˆè„šæœ¬ | å¢å¼ºç‰ˆè„šæœ¬ |
|------|----------|------------|
| åŸºæœ¬è¿æ¥ | âœ… | âœ… |
| è‡ªåŠ¨ç™»å½• | âœ… | âœ… |
| æ‰çº¿æ£€æµ‹ | âŒ | âœ… |
| è‡ªåŠ¨é‡è¿ | âŒ | âœ… |
| å¿ƒè·³ä¿æŒ | âŒ | âœ… |
| è¿æ¥æ—¥å¿— | âŒ | âœ… |
| æ‰‹åŠ¨é‡è¿ | âŒ | âœ… (Ctrl+R) |

## ä½¿ç”¨å»ºè®®

1. **æµ‹è¯•é˜¶æ®µ**ï¼šå…ˆä½¿ç”¨å¢å¼ºç‰ˆè„šæœ¬ `./smth-robust.tcl`
2. **æ»¡æ„å**ï¼šå¯é€‰æ‹©æ€§åœ°å‡çº§åŸè„šæœ¬
3. **ä¿é™©èµ·è§**ï¼šä½¿ç”¨å¯åŠ¨å™¨åœ¨ä¸¤ä¸ªç‰ˆæœ¬é—´åˆ‡æ¢

## é…ç½®å‚æ•°

å¢å¼ºç‰ˆè„šæœ¬çš„å¯è°ƒå‚æ•°ï¼š
- `heartbeat_interval`: å¿ƒè·³é—´éš”ï¼ˆé»˜è®¤120ç§’ï¼‰
- `max_reconnect_attempts`: æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆé»˜è®¤5æ¬¡ï¼‰
- `connection_timeout`: è¿æ¥è¶…æ—¶ï¼ˆé»˜è®¤30ç§’ï¼‰

## æ³¨æ„äº‹é¡¹

1. å¢å¼ºç‰ˆè„šæœ¬ä¿æŒäº†ä¸åŸè„šæœ¬ç›¸åŒçš„å‚æ•°æ¥å£
2. æ‰€æœ‰åŸæœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹
3. æ–°å¢çš„é˜²æ‰çº¿åŠŸèƒ½ä¸ä¼šå½±å“æ­£å¸¸ä½¿ç”¨
4. å¯ä»¥éšæ—¶å›é€€åˆ°åŸç‰ˆè„šæœ¬